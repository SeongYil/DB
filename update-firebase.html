<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore 문서 일괄 업데이트</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            background-color: #f4f7f6; 
            color: #333; 
            margin: 0; 
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        p {
            line-height: 1.6;
            color: #555;
        }
        #updateButton {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        #updateButton:hover {
            background-color: #d35400;
        }
        #updateButton:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        #logContainer {
            margin-top: 20px;
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Firestore 문서 일괄 업데이트</h1>
        <p>이 스크립트는 'helps' 컬렉션의 모든 문서를 확인하여, 대소문자 구분 없는 검색에 필요한 'keywords_lowercase' 필드를 추가합니다.</p>
        <p><strong>⚠️ 중요:</strong> 실행 전 Firestore 데이터를 백업하는 것을 권장합니다. 이 작업은 되돌릴 수 없습니다.</p>
        <button id="updateButton">모든 문서 업데이트 시작</button>
        <div id="logContainer">업데이트 로그가 여기에 표시됩니다.</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // -------------------------------------------------------------
        // 여기에 자신의 Firebase 설정을 붙여넣으세요.
        // -------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // 실제 사용하는 API 키로 변경해야 합니다.
            authDomain: "honey-db.firebaseapp.com",
            projectId: "honey-db",
            storageBucket: "honey-db.appspot.com",
            messagingSenderId: "199052115391",
            appId: "1:199052115391:web:db3bf8bc864a026d2f750a"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const updateButton = document.getElementById('updateButton');
        const logContainer = document.getElementById('logContainer');

        function log(message) {
            console.log(message);
            logContainer.innerHTML += `> ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        updateButton.addEventListener('click', async () => {
            updateButton.disabled = true;
            updateButton.textContent = '업데이트 중...';

            log('업데이트 프로세스를 시작합니다...');
            
            try {
                const helpsCollection = db.collection('helps');
                const snapshot = await helpsCollection.get();

                if (snapshot.empty) {
                    log('업데이트할 문서가 없습니다.');
                    updateButton.textContent = '완료 (문서 없음)';
                    return;
                }

                const batch = db.batch();
                let documentsToUpdateCount = 0;

                log(`총 ${snapshot.size}개의 문서를 확인합니다.`);

                snapshot.forEach(doc => {
                    const data = doc.data();
                    // 'keywords' 필드가 있고, 'keywords_lowercase' 필드가 없는 문서만 대상으로 합니다.
                    if (data.keywords && Array.isArray(data.keywords) && !data.keywords_lowercase) {
                        const keywordsLowercase = data.keywords.map(kw => kw.toLowerCase());
                        const docRef = helpsCollection.doc(doc.id);
                        batch.update(docRef, { keywords_lowercase: keywordsLowercase });
                        documentsToUpdateCount++;
                        log(`  - ${doc.id} 문서 업데이트 준비 완료.`);
                    }
                });

                if (documentsToUpdateCount === 0) {
                    log('모든 문서가 이미 최신 상태입니다. 업데이트할 필요가 없습니다.');
                    updateButton.textContent = '업데이트 완료 (변경 사항 없음)';
                    return;
                }

                log(`총 ${documentsToUpdateCount}개의 문서를 업데이트합니다...`);
                await batch.commit();
                log('-------------------------------------------');
                log('✅ 모든 문서가 성공적으로 업데이트되었습니다!');
                updateButton.textContent = '업데이트 성공!';

            } catch (error) {
                log('❌ 에러가 발생했습니다!');
                log(error.message);
                console.error("Error updating documents: ", error);
                updateButton.textContent = '업데이트 실패';
                updateButton.style.backgroundColor = '#c0392b';
            }
        });
    </script>
</body>
</html>
