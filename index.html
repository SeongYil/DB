<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 문서 시스템</title>
    <style>
        /* CSS는 변경 사항 없음 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 40px;
            background-color: #34495e;
            color: white;
            user-select: none;
            flex-shrink: 0;
        }

        .app-header h1 {
            margin: 0;
            font-size: 24px;
        }

        #app-title {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        .info-text {
            color: #95a5a6;
            text-align: center;
            padding: 20px;
        }

        h2,
        h3,
        h4 {
            color: #2c3e50;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        .app-header h1,
        #mainContentContainer h2,
        .keyword-tag-container h4,
        .result-item h3 {
            border: none;
            padding-bottom: 0;
        }

        #auth-status button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
            transition: background-color 0.2s;
        }

        #auth-status button:hover {
            background-color: #2980b9;
        }

        #auth-status #login-btn {
            background-color: #2ecc71;
        }

        #auth-status #login-btn:hover {
            background-color: #27ae60;
        }

        .user-display {
            display: flex;
            align-items: center;
        }

        .user-email {
            font-weight: bold;
            margin-right: 15px;
        }

        .viewer-layout {
            display: flex;
            justify-content: center;
            padding: 0 40px;
            gap: 30px;
            flex-grow: 1;
        }

        .main-content-area {
            width: 100%;
            max-width: 800px;
            flex-shrink: 0;
        }

        .side-margin {
            flex: 1 1 260px;
            max-width: 1000px;
            font-size: 14px;
            color: #555;
            padding-top: 30px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #viewer-container .container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        .search-box {
            display: flex;
            margin: 20px 0;
        }

        #searchInput {
            flex-grow: 1;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px 0 0 5px;
            outline: none;
            transition: border-color 0.3s;
        }

        #searchInput:focus {
            border-color: #3498db;
        }

        #searchButton {
            padding: 0 25px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #3498db;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #searchButton:hover {
            background-color: #2980b9;
        }

        #mainContentContainer div,
        .result-item div {
            white-space: pre-wrap;
            word-wrap: break-word;
            user-select: text;
        }

        #mainContentContainer a,
        .result-item a {
            color: #3498db;
            font-weight: 600;
            text-decoration: underline;
        }

        #mainContentContainer a:hover,
        .result-item a:hover {
            color: #2980b9;
        }

        #breadcrumbContainer {
            padding: 10px 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
            margin-bottom: 20px;
            min-height: 20px;
        }

        .breadcrumb-path {
            margin-bottom: 5px;
        }

        .breadcrumb-path:last-child {
            margin-bottom: 0;
        }

        .breadcrumb-item {
            color: #2980b9;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            margin: 0 10px;
            color: #7f8c8d;
        }

        .breadcrumb-current {
            color: #34495e;
            font-weight: bold;
        }

        #mainContentContainer {
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }

        .keyword-tag-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .keyword-tag-container h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .keyword-tag {
            display: inline-block;
            background-color: #7f8c8d;
            color: white;
            padding: 4px 10px;
            margin-right: 8px;
            margin-bottom: 8px;
            border-radius: 15px;
            font-size: 13px;
        }

        #resultsContainer {
            margin-top: 20px;
        }

        .result-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .result-item:hover {
            background-color: #f0f0f0;
        }

        .result-item h3 {
            margin: 0 0 10px;
            color: #2980b9;
        }

        .highlight {
            background-color: #f1c40f;
            color: #333;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .search-category-header {
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }

        .search-result-separator {
            margin: 40px 0;
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.25), rgba(0, 0, 0, 0));
        }

        #viewer-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        #admin-container {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
        }

        .admin-management-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
        }

        .input-with-button input {
            flex-grow: 1;
        }

        .input-with-button button {
            padding: 10px 20px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #admin-email-list {
            list-style-type: none;
            padding: 0;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        #admin-email-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        #admin-email-list li:last-child {
            border-bottom: none;
        }

        /* 여기가 수정된 부분이야! */
        #admin-email-list .remove-admin-btn {
            background-color: #c0392b;
            color: white;
            border: none;
            /* '추가' 버튼과 동일한 크기를 갖도록 padding 값을 수정했어. */
            padding: 10px 20px; 
            /* '추가' 버튼과 모서리 둥근 정도를 맞췄어. */
            border-radius: 5px; 
            cursor: pointer;
            /* 폰트 크기를 지정하지 않아서 '추가' 버튼과 동일한 크기를 상속받도록 했어. */
        }

        .admin-layout {
            display: flex;
            gap: 0;
            flex-grow: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        #tree-container {
            width: 30%;
            min-width: 250px;
            background-color: #ffffff;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .tree-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
            flex-wrap: wrap;
            gap: 10px;
        }

        #add-new-button,
        #edit-global-notice-button,
        #manage-admins-button {
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            color: white;
        }

        #add-new-button {
            background-color: #3498db;
        }

        #edit-global-notice-button {
            background-color: #27ae60;
        }

        #manage-admins-button {
            background-color: #8e44ad;
        }

        #tree-root {
            flex-grow: 1;
            overflow: auto;
            user-select: none;
        }

        #resizer {
            flex-shrink: 0;
            width: 10px;
            background-color: #ecf0f1;
            cursor: col-resize;
            user-select: none;
        }

        #editor-container {
            flex-grow: 1;
            background-color: #ffffff;
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            flex-wrap: wrap;
        }

        .form-group label .label-buttons {
            display: flex;
            gap: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            user-select: text;
        }

        #editor-contents-textarea {
            resize: vertical;
            min-height: 80px;
            overflow-y: hidden;
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 40px;
        }

        .tag-item {
            display: flex;
            align-items: center;
            background-color: #3498db;
            color: white;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 15px;
            font-size: 14px;
        }

        .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        #parent-display-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #parent-display {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 4px;
            min-height: 20px;
        }

        .parent-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background-color: #95a5a6;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .remove-parent-tag {
            margin-left: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .remove-parent-tag:hover {
            opacity: 1;
        }

        #change-parent-btn {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            background-color: #fdfdfd;
            border-radius: 5px;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        #save-button,
        #delete-button,
        #save-global-notice-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        #save-button,
        #save-global-notice-button {
            background-color: #27ae60;
            color: white;
        }

        #delete-button {
            background-color: #c0392b;
            color: white;
        }

        .inline-btn {
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: normal;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .inline-btn:hover {
            background-color: #e0e4e8;
        }

        .file-path-container {
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 8px 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }

        .path-text {
            color: #495057;
            flex-grow: 1;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: thin;
        }

        .copy-path-btn {
            margin-left: 12px;
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }

        .copy-path-btn:hover {
            background-color: #5a6268;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 20px 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 85%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modal-content.modal-confirm {
            max-width: 400px;
            max-height: 50%;
        }

        #hyperlink-modal,
        #filepath-modal,
        #admin-management-modal {
            max-width: 500px;
        }

        #modal-search-input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        #modal-tree-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
        }

        .modal-buttons {
            text-align: right;
            margin-top: 15px;
            flex-shrink: 0;
        }

        .modal-buttons button {
            padding: 8px 15px;
            margin-left: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        #modal-add-link,
        #modal-select,
        #modal-add-filepath,
        #modal-confirm {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .modal-buttons #modal-confirm-delete {
            background-color: #c0392b;
            color: white;
            border-color: #c0392b;
        }

        #tree-root>ul {
            padding-left: 0;
        }

        #tree-root ul,
        #modal-tree-container ul {
            list-style-type: none;
            padding-left: 20px;
            position: relative;
        }

        #tree-root li,
        #modal-tree-container li {
            margin: 2px 0;
            white-space: nowrap;
        }

        #modal-tree-container ul {
            border-left: 1px solid #ddd;
        }

        #modal-tree-container li {
            display: flex;
            flex-direction: column;
        }

        #modal-tree-container li::before {
            content: '';
            position: absolute;
            top: 15px;
            left: -20px;
            border-bottom: 1px solid #ddd;
            width: 15px;
            height: 0;
        }

        .item-container {
            display: flex;
            align-items: center;
        }

        .toggle-btn {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin-right: 4px;
            display: inline-block;
            width: 20px;
            text-align: center;
            color: #7f8c8d;
        }

        .modal-checkbox {
            cursor: pointer;
            margin-right: 4px;
            width: 20px;
            accent-color: #3498db;
        }

        .tree-item-title {
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
            display: inline-block;
        }

        .tree-item-title:hover {
            background-color: #f0f0f0;
        }

        #tree-root .tree-item-title.active {
            background-color: #e0eaf1;
            font-weight: bold;
        }

        #modal-tree-container .tree-item-title {
            cursor: default;
        }

        li.collapsed>ul {
            display: none;
        }

        .tree-item-title.dragging {
            opacity: 0.4;
        }

        .tree-item-title.drop-target {
            background-color: #a2d9ce;
            border: 2px dashed #1abc9c;
        }

        @media (max-width: 1400px) {
            .side-margin {
                display: none;
            }

            .viewer-layout {
                padding: 0 20px;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 10px;
                padding: 10px 20px;
            }

            #admin-container {
                padding: 10px;
            }

            .admin-layout {
                flex-direction: column;
                height: auto;
                max-height: calc(100vh - 200px);
            }

            #tree-container {
                width: 100%;
                height: 40vh;
                min-height: 200px;
            }

            #resizer {
                display: none;
            }

            #editor-container {
                flex-grow: 1;
            }
        }
    </style>
</head>

<body>
    <div class="app-header">
        <h1><a href="#" id="app-title">통합 문서 시스템</a></h1>
        <div id="auth-status">
            <button id="login-btn">Google 계정으로 로그인</button>
        </div>
    </div>

    <div id="viewer-container">
        <div class="viewer-layout">
            <div id="leftMargin" class="side-margin"></div>
            <div class="main-content-area">
                <div class="container">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="검색할 키워드를 입력하세요...">
                        <button id="searchButton">검색</button>
                    </div>
                    <hr>
                    <div id="breadcrumbContainer"></div>
                    <div id="mainContentContainer"></div>
                    <div id="resultsContainer">
                        <p class="info-text">데이터를 불러오는 중입니다...</p>
                    </div>
                </div>
            </div>
            <div class="side-margin"></div>
        </div>
    </div>

    <div id="admin-container">
        <div class="admin-layout">
            <div id="tree-container">
                <div class="tree-header">
                    <button id="add-new-button">새 문서 추가</button>
                    <button id="edit-global-notice-button">공지/안내문 수정</button>
                    <button id="manage-admins-button">관리자 권한 설정</button>
                </div>
                <div id="tree-root"></div>
            </div>
            <div id="resizer"></div>
            <div id="editor-container">
                <div id="editor-content">
                    <p class="info-text">왼쪽 트리에서 항목을 선택하거나, 새 문서를 추가하세요.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase 모듈 가져오기
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getFirestore,
            collection,
            doc,
            getDoc,
            getDocs,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            query,
            where,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // -------------------------------------------------------------
        // Firebase 설정
        // -------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCBimrNdCRm88oFQZtk2ZwTOjnhrFt9y8U",
            authDomain: "honey-db.firebaseapp.com",
            projectId: "honey-db",
            storageBucket: "honey-db.appspot.com",
            messagingSenderId: "199052115391",
            appId: "1:199052115391:web:db3bf8bc864a026d2f750a"
        };

        // Firebase 앱 초기화
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase 초기화 오류:", e);
        }

        // -------------------------------------------------------------
        // HTML 요소 가져오기
        // -------------------------------------------------------------
        const authStatusContainer = document.getElementById('auth-status');
        const viewerContainer = document.getElementById('viewer-container');
        const adminContainer = document.getElementById('admin-container');
        const appTitle = document.getElementById('app-title');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const viewerMainContent = document.getElementById('mainContentContainer');
        const viewerResults = document.getElementById('resultsContainer');
        const breadcrumbContainer = document.getElementById('breadcrumbContainer');
        const leftMarginContainer = document.getElementById('leftMargin');
        const treeContainer = document.getElementById('tree-container');
        const editorContainer = document.getElementById('editor-container');
        const resizer = document.getElementById('resizer');
        const treeRoot = document.getElementById('tree-root');
        const editorContent = document.getElementById('editor-content');


        // -------------------------------------------------------------
        // 상태 관리 변수
        // -------------------------------------------------------------
        let breadcrumbTrail = [];
        let currentSelectedDocId = null;
        let allDocsMap = new Map();
        const EXPANDED_STATE_KEY = 'treeExpandedState';
        let isCurrentUserAdmin = false;

        // =============================================================
        //  인증 (Authentication) 관련 함수들
        // =============================================================

        function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("로그인 팝업 에러:", error);
                    showModalAlert(`로그인 중 에러가 발생했습니다: ${error.code}`);
                });
        }

        function handleSignOut() {
            signOut(auth);
        }

        async function checkAdminStatus(email) {
            if (!db) return false;
            try {
                const adminDocRef = doc(db, 'admins', 'authorized_users');
                const adminDoc = await getDoc(adminDocRef);
                if (adminDoc.exists()) {
                    const adminEmails = adminDoc.data().emails || [];
                    return adminEmails.includes(email);
                } else {
                    console.log("INFO: 'admins/authorized_users' 문서가 아직 없습니다.");
                    return false;
                }
            } catch (error) {
                console.error("관리자 확인 중 에러:", error);
                return false;
            }
        }

        function updateAuthUI(user, isAdmin) {
            authStatusContainer.innerHTML = '';
            if (user) {
                const userDisplay = document.createElement('div');
                userDisplay.className = 'user-display';
                userDisplay.innerHTML = `
                <span class="user-email">${isAdmin ? '👑' : ''} ${user.displayName || user.email}</span>
                ${isAdmin ? '<button id="mode-toggle-btn">관리자 페이지</button>' : ''}
                <button id="logout-btn">로그아웃</button>
            `;
                authStatusContainer.appendChild(userDisplay);

                document.getElementById('logout-btn').addEventListener('click', handleSignOut);

                if (isAdmin) {
                    const toggleBtn = document.getElementById('mode-toggle-btn');
                    if (toggleBtn) toggleBtn.addEventListener('click', toggleMode);
                }
            } else {
                const loginBtn = document.createElement('button');
                loginBtn.id = 'login-btn';
                loginBtn.textContent = 'Google 계정으로 로그인';
                loginBtn.addEventListener('click', signInWithGoogle);
                authStatusContainer.appendChild(loginBtn);
            }
        }

        // =============================================================
        //  관리자 권한 관리 (Admin Management) 함수들
        // =============================================================

        async function openAdminManagementUI() {
            if (!isCurrentUserAdmin) {
                showModalAlert("이 기능을 사용할 권한이 없습니다.");
                return;
            }
            
            closeModal(); 
            
            const fetchedAdmins = await fetchAdmins();
            const adminList = Array.isArray(fetchedAdmins) ? fetchedAdmins : [];

            const modalContentHTML = `
                <h3>관리자 권한 설정</h3>
                <div class="admin-management-box">
                    <div class="form-group">
                        <label>새 관리자 이메일 추가</label>
                        <div class="input-with-button">
                            <input type="email" id="new-admin-email-modal" placeholder="admin@example.com">
                            <button id="add-admin-btn-modal">추가</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>현재 관리자 목록</label>
                        <ul id="admin-email-list">
                            ${adminList.length > 0 ? adminList.map(email => `<li><span>${email}</span><button class="remove-admin-btn" data-email="${email}">삭제</button></li>`).join('') : '<li>등록된 관리자가 없습니다.</li>'}
                        </ul>
                    </div>
                </div>
            `;

            showModal({ content: modalContentHTML, id: 'admin-management-modal' });

            const modalNode = document.getElementById('admin-management-modal');
            if (modalNode) {
                modalNode.querySelector('#add-admin-btn-modal').addEventListener('click', addAdminEmail);
                modalNode.querySelectorAll('.remove-admin-btn').forEach(button => {
                    button.addEventListener('click', (event) => removeAdminEmail(event));
                });
            }
        }

        async function fetchAdmins() {
            if (!db) return [];
            try {
                const docRef = doc(db, 'admins', 'authorized_users');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().emails || [];
                }
                return [];
            } catch (error) {
                console.error("관리자 목록 로딩 에러:", error);
                return [];
            }
        }

        async function addAdminEmail() {
            const input = document.getElementById('new-admin-email-modal');
            if (!input) return;
            const email = input.value.trim();
            if (!email) return;

            if (!email.toLowerCase().endsWith('@gmail.com')) {
                showModalAlert("구글 이메일 주소(@gmail.com)만 관리자로 추가할 수 있습니다.");
                return;
            }

            const docRef = doc(db, 'admins', 'authorized_users');
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    await updateDoc(docRef, {
                        emails: arrayUnion(email)
                    });
                } else {
                    await setDoc(docRef, {
                        emails: [email]
                    });
                }
                const adminListUl = document.getElementById('admin-email-list');
                if(adminListUl.querySelector('li')?.textContent === '등록된 관리자가 없습니다.') {
                    adminListUl.innerHTML = '';
                }
                const newLi = document.createElement('li');
                newLi.innerHTML = `<span>${email}</span><button class="remove-admin-btn" data-email="${email}">삭제</button>`;
                adminListUl.appendChild(newLi);
                newLi.querySelector('.remove-admin-btn').addEventListener('click', (event) => removeAdminEmail(event));

                input.value = '';

            } catch (error) {
                console.error("관리자 추가 에러:", error);
                showModalAlert("관리자 추가에 실패했습니다.");
            }
        }
        
        async function removeAdminEmail(event) {
            const button = event.target;
            const email = button.dataset.email;
            const listItem = button.closest('li');
            if (!email) return;

            showModal({
                 content: `<p style="margin-top:0;">'${email}' 관리자를 정말 삭제하시겠습니까?</p>`,
                 confirmText: '삭제',
                 confirmId: 'modal-confirm-delete',
                 modalClass: 'modal-confirm',
                 onConfirm: async () => {
                     try {
                         const docRef = doc(db, 'admins', 'authorized_users');
                         await updateDoc(docRef, {
                             emails: arrayRemove(email)
                         });
                         listItem.remove();
                         closeModal();
                     } catch (error) {
                         console.error("관리자 삭제 에러:", error);
                         closeModal();
                         showModalAlert("관리자 삭제에 실패했습니다.");
                     }
                 }
            });
        }

        // =============================================================
        //  뷰어 모드 (Viewer Mode) 함수들
        // =============================================================

        function renderBreadcrumbs() {
            breadcrumbContainer.innerHTML = '';
            if (!breadcrumbTrail || breadcrumbTrail.length === 0) return;
            breadcrumbTrail.forEach(path => {
                const pathContainer = document.createElement('div');
                pathContainer.className = 'breadcrumb-path';
                path.forEach((item, index) => {
                    let element;
                    if (index === path.length - 1) {
                        element = document.createElement('span');
                        element.className = 'breadcrumb-current';
                        element.textContent = item.title;
                    } else {
                        element = document.createElement('a');
                        element.className = 'breadcrumb-item';
                        element.textContent = item.title;
                        element.href = '#';
                        element.onclick = (e) => {
                            e.preventDefault();
                            navigateTo(item.id, item.title);
                        };
                    }
                    pathContainer.appendChild(element);
                    if (index < path.length - 1) {
                        const separator = document.createElement('span');
                        separator.className = 'breadcrumb-separator';
                        separator.textContent = '>';
                        pathContainer.appendChild(separator);
                    }
                });
                breadcrumbContainer.appendChild(pathContainer);
            });
        }

        async function buildAllBreadcrumbPaths(startDocId) {
            if (!db) return [];
            if (allDocsMap.size === 0) {
                const snapshot = await getDocs(collection(db, "helps"));
                snapshot.forEach(doc => {
                    allDocsMap.set(doc.id, {
                        id: doc.id,
                        data: doc.data(),
                        children: []
                    });
                });
            }
            if (!startDocId || !allDocsMap.has(startDocId)) {
                return [];
            }
            const docNode = allDocsMap.get(startDocId);
            const currentDocInfo = {
                id: startDocId,
                title: docNode.data.title
            };
            const parentIds = docNode.data.parentIds || [];
            if (parentIds.length === 0) {
                return [
                    [{
                        id: null,
                        title: 'Home'
                    }, currentDocInfo]
                ];
            }
            let allPaths = [];
            for (const parentId of parentIds) {
                const parentPaths = await buildAllBreadcrumbPaths(parentId);
                for (const path of parentPaths) {
                    allPaths.push([...path, currentDocInfo]);
                }
            }
            return allPaths;
        }

        async function navigateTo(docId, docTitle) {
            if (!db) return;
            if (docId) {
                breadcrumbTrail = await buildAllBreadcrumbPaths(docId);
            } else {
                breadcrumbTrail = [
                    [{
                        id: null,
                        title: 'Home'
                    }]
                ];
            }
            renderBreadcrumbs();

            viewerMainContent.innerHTML = '';
            viewerResults.innerHTML = '<p class="info-text">목록을 불러오는 중...</p>';

            if (docId) {
                try {
                    const docRef = doc(db, "helps", docId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        let keywordsHtml = '';
                        if (data.keywords && data.keywords.length > 0) {
                            keywordsHtml = `<div class="keyword-tag-container"><h4>관련 키워드</h4>${data.keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')}</div>`;
                        }
                        viewerMainContent.innerHTML = `<h2>${data.title}</h2><div>${data.contents || '내용이 없습니다.'}</div>${keywordsHtml}`;
                    } else {
                        viewerMainContent.innerHTML = '<h4>문서가 존재하지 않습니다.</h4>';
                    }
                } catch (error) {
                    console.error("메인 컨텐츠 로딩 오류:", error);
                    viewerMainContent.innerHTML = '<h4>컨텐츠를 불러오는 데 실패했습니다.</h4>';
                }
            } else {
                viewerMainContent.innerHTML = '<h2>Home</h2><p>최상위 문서 목록입니다.</p>';
            }

            try {
                const q = docId === null ?
                    query(collection(db, "helps"), where("parentIds", "==", [])) :
                    query(collection(db, "helps"), where("parentIds", "array-contains", docId));

                const snapshot = await getDocs(q);
                viewerResults.innerHTML = '';
                if (snapshot.empty) {
                    viewerResults.innerHTML = '<p class="info-text">하위 항목이 없습니다.</p>';
                } else {
                    const childDocs = [];
                    snapshot.forEach(doc => {
                        childDocs.push({
                            id: doc.id,
                            data: doc.data()
                        });
                    });
                    childDocs.sort((a, b) => a.data.title.localeCompare(b.data.title, 'ko'));
                    childDocs.forEach(child => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';
                        resultItem.innerHTML = `<h3>${child.data.title}</h3>`;
                        resultItem.onclick = () => navigateTo(child.id, child.data.title);
                        viewerResults.appendChild(resultItem);
                    });
                }
            } catch (error) {
                console.error("하위 목록 탐색 중 오류:", error);
                viewerResults.innerHTML = '<p class="info-text">하위 목록을 불러오는 데 실패했습니다.</p>';
            }
        }

        async function performSearch() {
            if (!db) return;
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) return;

            const searchTermLower = searchTerm.toLowerCase();
            viewerMainContent.innerHTML = `<h2>'${searchTerm}' 검색 결과</h2>`;
            breadcrumbContainer.innerHTML = '';
            viewerResults.innerHTML = '<p class="info-text">검색 중입니다...</p>';

            try {
                const q = query(collection(db, "helps"), where("keywords_lowercase", "array-contains", searchTermLower));
                const snapshot = await getDocs(q);
                viewerResults.innerHTML = '';

                if (snapshot.empty) {
                    viewerResults.innerHTML = '<p class="info-text">검색 결과가 없습니다.</p>';
                    return;
                }
                const results = [];
                snapshot.forEach(doc => results.push({
                    id: doc.id,
                    data: doc.data()
                }));
                results.sort((a, b) => a.data.title.localeCompare(b.data.title, 'ko'));

                const regex = new RegExp(searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
                results.forEach(doc => {
                    const data = doc.data;
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';

                    const highlightedTitle = data.title.replace(regex, `<mark class="highlight">$&</mark>`);
                    const snippet = (data.contents || '').substring(0, 150) + '...';
                    const highlightedContents = snippet.replace(regex, `<mark class="highlight">$&</mark>`);

                    resultItem.innerHTML = `<h3>${highlightedTitle}</h3><div>${highlightedContents}</div><p style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">매칭 키워드: ${data.keywords.filter(k => k.toLowerCase().includes(searchTermLower)).join(', ')}</p>`;
                    resultItem.onclick = () => navigateTo(doc.id, data.title);
                    viewerResults.appendChild(resultItem);
                });

            } catch (error) {
                console.error("검색 중 오류 발생:", error);
                viewerResults.innerHTML = '<p class="info-text">검색에 실패했습니다.</p>';
            }
        }

        // =============================================================
        //  관리자 모드 (Admin Mode) 함수들
        // =============================================================
        function getExpandedState() {
            try {
                return localStorage.getItem(EXPANDED_STATE_KEY) ? JSON.parse(localStorage.getItem(EXPANDED_STATE_KEY)) : [];
            } catch {
                return [];
            }
        }

        function saveExpandedState(expandedIds) {
            try {
                localStorage.setItem(EXPANDED_STATE_KEY, JSON.stringify(expandedIds));
            } catch (e) {
                console.error("로컬 스토리지 저장 실패", e)
            }
        }

        function prepareNewDocumentForm() {
            currentSelectedDocId = null;
            const currentActive = document.querySelector('#tree-root .tree-item-title.active');
            if (currentActive) {
                currentActive.classList.remove('active');
            }
            loadDocumentIntoEditor(null, {
                title: '',
                contents: '',
                keywords: [],
                parentIds: []
            });
            if (document.getElementById('editor-title-input')) {
                document.getElementById('editor-title-input').focus();
            }
        }

        async function saveChanges() {
            if (!db) return;
            const newTitle = document.getElementById('editor-title-input').value;
            const newContents = document.getElementById('editor-contents-textarea').value;
            const parentSpans = document.querySelectorAll('#parent-display .parent-tag');
            const newParentIds = Array.from(parentSpans).map(span => span.dataset.parentId);
            const newKeywords = Array.from(document.querySelectorAll('.tag-item')).map(tag => tag.firstChild.textContent.trim());
            const newKeywordsLowercase = newKeywords.map(kw => kw.toLowerCase());

            if (!newTitle) {
                showModalAlert("제목은 필수 항목입니다.");
                return;
            }
            const saveButton = document.getElementById('save-button');
            saveButton.textContent = '저장 중...';
            saveButton.disabled = true;
            try {
                const docData = {
                    title: newTitle,
                    contents: newContents,
                    keywords: newKeywords,
                    keywords_lowercase: newKeywordsLowercase,
                    parentIds: newParentIds,
                };
                if (currentSelectedDocId) {
                    const docRef = doc(db, "helps", currentSelectedDocId);
                    await updateDoc(docRef, docData);
                } else {
                    const docRef = await addDoc(collection(db, "helps"), docData);
                    currentSelectedDocId = docRef.id;
                }
                await buildAndRenderTree();
            } catch (error) {
                console.error("저장 중 오류 발생:", error);
                showModalAlert("저장에 실패했습니다.");
            } finally {
                if (document.getElementById('save-button')) {
                    document.getElementById('save-button').textContent = '저장하기';
                    document.getElementById('save-button').disabled = false;
                }
            }
        }

        async function deleteDocument() {
            if (!db) return;
            if (!currentSelectedDocId) {
                showModalAlert("삭제할 항목을 먼저 선택해주세요.");
                return;
            }

            showModal({
                content: `<p style="margin-top:0;">정말 이 문서를 삭제하시겠습니까? 하위 문서들의 연결이 끊어질 수 있습니다.</p>`,
                confirmText: '삭제',
                confirmId: 'modal-confirm-delete',
                modalClass: 'modal-confirm',
                onConfirm: async () => {
                    closeModal(); // 확인 모달을 먼저 닫습니다.
                    try {
                        await deleteDoc(doc(db, "helps", currentSelectedDocId));
                        editorContent.innerHTML = '<p class="info-text">왼쪽 트리에서 항목을 선택하거나, 새 문서를 추가하세요.</p>';
                        currentSelectedDocId = null;
                        await buildAndRenderTree();
                    } catch (error) {
                        console.error("삭제 중 오류 발생:", error);
                        showModalAlert("삭제에 실패했습니다.");
                    }
                }
            });
        }


        function loadDocumentIntoEditor(docId, docData) {
            currentSelectedDocId = docId;
            const parentIds = docData.parentIds || [];

            editorContent.innerHTML = `
                <h3>${docData.title || '새 문서 작성'}</h3>
                <div class="form-group">
                    <label for="editor-title-input">제목</label>
                    <input type="text" id="editor-title-input" value="${docData.title || ''}">
                </div>
                <div class="form-group">
                    <label for="editor-contents-textarea">
                        <span>내용</span>
                        <span class="label-buttons">
                            <button id="add-hyperlink-btn" class="inline-btn">하이퍼링크 추가</button>
                            <button id="add-filepath-btn" class="inline-btn">폴더/파일 경로 추가</button>
                        </span>
                    </label>
                    <textarea id="editor-contents-textarea" placeholder="여기에 내용을 입력하세요... HTML 태그 사용이 가능합니다."></textarea>
                </div>
                <div class="form-group">
                    <label>검색 키워드</label>
                    <div id="tag-container" class="tag-input-container">
                        <input type="text" id="tag-input" placeholder="키워드 입력 후 Enter">
                    </div>
                </div>
                <div class="form-group">
                    <label>부모 문서</label>
                    <div id="parent-display-wrapper">
                        <div id="parent-display"></div>
                        <button id="change-parent-btn">변경</button>
                    </div>
                </div>
                <div class="button-group">
                    <button id="save-button">저장하기</button>
                    ${docId ? '<button id="delete-button">삭제하기</button>' : ''}
                </div>`;

            const parentDisplay = document.getElementById('parent-display');
            updateParentDisplay(parentIds);

            parentDisplay.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-parent-tag')) {
                    e.target.parentElement.remove();
                    if (parentDisplay.children.length === 0) {
                        parentDisplay.textContent = '없음';
                    }
                }
            });

            const mainTextarea = document.getElementById('editor-contents-textarea');
            mainTextarea.value = docData.contents || '';

            function autoResize() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            }

            mainTextarea.addEventListener('input', autoResize, false);
            setTimeout(() => {
                if (mainTextarea) autoResize.call(mainTextarea);
            }, 0);

            document.getElementById('save-button').onclick = saveChanges;
            if (docId) {
                document.getElementById('delete-button').onclick = deleteDocument;
            }
            document.getElementById('change-parent-btn').onclick = () => setupParentSelectorModal(parentIds);
            document.getElementById('add-hyperlink-btn').onclick = openHyperlinkModal;
            document.getElementById('add-filepath-btn').onclick = openFilePathModal;
            setupTagInput(docData.keywords || []);
        }

        function updateParentDisplay(parentIds) {
            const parentDisplay = document.getElementById('parent-display');
            parentDisplay.innerHTML = '';
            if (parentIds && parentIds.length > 0) {
                parentIds.forEach(pId => {
                    const parentNode = allDocsMap.get(pId);
                    if (parentNode) {
                        const parentTag = document.createElement('div');
                        parentTag.className = 'parent-tag';
                        parentTag.dataset.parentId = pId;
                        parentTag.innerHTML = `<span>${parentNode.data.title}</span><span class="remove-parent-tag" title="삭제">x</span>`;
                        parentDisplay.appendChild(parentTag);
                    }
                });
            } else {
                parentDisplay.textContent = '없음';
            }
        }

        async function buildAndRenderTree() {
            if (!db || !treeRoot) return;
            treeRoot.innerHTML = '<p class="info-text">데이터 로딩 중...</p>';
            try {
                const snapshot = await getDocs(collection(db, "helps"));
                if (snapshot.empty) {
                    treeRoot.innerHTML = '<p class="info-text">데이터가 없습니다.</p>';
                    return;
                }
                allDocsMap.clear();
                snapshot.forEach(doc => {
                    allDocsMap.set(doc.id, {
                        id: doc.id,
                        data: doc.data(),
                        children: []
                    });
                });
                const tree = buildTreeFromMap();
                tree.sort((a, b) => a.data.title.localeCompare(b.data.title, 'ko'));

                treeRoot.innerHTML = '';
                const rootUl = document.createElement('ul');
                treeRoot.appendChild(rootUl);
                renderTree(tree, rootUl, false);

                if (currentSelectedDocId && document.getElementById('parent-display')) {
                    const docData = allDocsMap.get(currentSelectedDocId)?.data;
                    if (docData) {
                        updateParentDisplay(docData.parentIds || []);
                    }
                }

            } catch (error) {
                console.error("트리 생성 중 오류:", error);
                treeRoot.innerHTML = '<p class="info-text">데이터를 불러오는 데 실패했습니다.</p>';
            }
        }

        function buildTreeFromMap() {
            allDocsMap.forEach(node => node.children = []);
            const tree = [];
            allDocsMap.forEach(node => {
                const parentIds = node.data.parentIds || [];
                if (parentIds.length === 0) {
                    tree.push(node);
                } else {
                    parentIds.forEach(parentId => {
                        if (allDocsMap.has(parentId)) {
                            allDocsMap.get(parentId).children.push(node);
                        }
                    });
                }
            });
            allDocsMap.forEach(node => {
                // 각 노드의 자식들을 유니크하게 만들고 정렬합니다.
                if (node.children.length > 1) {
                    const uniqueChildren = Array.from(new Map(node.children.map(child => [child.id, child])).values());
                    node.children = uniqueChildren;
                }
                if (node.children.length > 0) {
                    node.children.sort((a, b) => a.data.title.localeCompare(b.data.title, 'ko'));
                }
            });
            return tree;
        }


        // =============================================================
        //  UI 유틸리티 함수들
        // =============================================================

        function openHyperlinkModal() {
             showModal({
                content: `
                    <h3>하이퍼링크 추가</h3>
                    <div class="form-group">
                        <label for="link-text-input"><span>내용 (표시될 텍스트)</span></label>
                        <input type="text" id="link-text-input" placeholder="예: 구글 홈페이지">
                    </div>
                    <div class="form-group">
                        <label for="link-url-input"><span>경로 (URL)</span></label>
                        <input type="text" id="link-url-input" placeholder="예: google.com">
                    </div>
                `,
                confirmText: '추가',
                id: 'hyperlink-modal',
                onConfirm: insertHyperlink
            });
        }

        function insertHyperlink() {
            const text = document.getElementById('link-text-input').value.trim();
            let url = document.getElementById('link-url-input').value.trim();

            if (!text || !url) {
                showModalAlert('내용과 경로를 모두 입력해주세요.');
                return;
            }

            if (!url.toLowerCase().startsWith('http://') && !url.toLowerCase().startsWith('https://')) {
                url = 'https://' + url;
            }

            const hyperlink = `<a href="${url}" target="_blank" rel="noopener noreferrer">${text}</a>`;
            insertTextIntoTextarea(hyperlink);
            closeModal();
        }

        function openFilePathModal() {
            showModal({
                content: `
                    <h3>공유 폴더/파일 경로 추가</h3>
                    <div class="form-group">
                        <label for="filepath-input"><span>경로</span></label>
                        <input type="text" id="filepath-input" placeholder="예: \\\\Server\\Share\\Folder">
                    </div>
                `,
                confirmText: '추가',
                id: 'filepath-modal',
                onConfirm: insertFilePath
            });
        }

        function insertFilePath() {
            const path = document.getElementById('filepath-input').value.trim();
            if (!path) {
                showModalAlert('경로를 입력해주세요.');
                return;
            }
            const filePathHtml = `<div class="file-path-container"><span class="path-text">${path}</span><button type="button" class="copy-path-btn" data-path="${path}">복사</button></div>`;
            insertTextIntoTextarea(filePathHtml);
            closeModal();
        }

        function insertTextIntoTextarea(htmlToInsert) {
            const textarea = document.getElementById('editor-contents-textarea');
            if (!textarea) return;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const textBefore = textarea.value.substring(0, start);
            const textAfter = textarea.value.substring(end, textarea.value.length);
            textarea.value = textBefore + htmlToInsert + textAfter;

            textarea.selectionStart = textarea.selectionEnd = start + htmlToInsert.length;
            textarea.focus();
            textarea.dispatchEvent(new Event('input', {
                bubbles: true
            }));
        }

        function setupTagInput(keywords) {
            const container = document.getElementById('tag-container');
            const input = document.getElementById('tag-input');
            if (!container || !input) return;
            keywords.forEach(keyword => container.insertBefore(createTag(keyword), input));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const tagText = input.value.trim();
                    if (tagText) {
                        container.insertBefore(createTag(tagText), input);
                        input.value = '';
                    }
                }
            });
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-tag')) e.target.parentElement.remove();
            });
        }

        function createTag(text) {
            const tag = document.createElement('div');
            tag.className = 'tag-item';
            tag.innerHTML = `<span>${text}</span> <span class="remove-tag" title="삭제">x</span>`;
            return tag;
        }

        function setupParentSelectorModal(currentParentIds = []) {
            const content = `
                <h3>부모 문서 선택</h3>
                <input type="text" id="modal-search-input" placeholder="검색으로 필터링...">
                <div id="modal-tree-container"></div>
            `;
            showModal({
                content: content,
                confirmText: '선택 완료',
                onConfirm: () => {
                    const selectedIds = [];
                    document.querySelectorAll('#modal-tree-container input[type="checkbox"]:checked').forEach(cb => {
                        selectedIds.push(cb.dataset.id);
                    });
                    updateParentDisplay(selectedIds);
                    closeModal();
                }
            });

            const modalTreeContainer = document.getElementById('modal-tree-container');
            const searchInput = document.getElementById('modal-search-input');

            const renderModalTree = (filterText = '') => {
                modalTreeContainer.innerHTML = '';
                const rootUl = document.createElement('ul');
                modalTreeContainer.appendChild(rootUl);
                const tree = buildTreeFromMap();
                tree.sort((a, b) => a.data.title.localeCompare(b.data.title, 'ko'));
                const filteredTree = filterText ? filterTree(tree, filterText.toLowerCase()) : tree;
                renderTree(filteredTree, rootUl, true, currentParentIds);
            };
            renderModalTree();
            searchInput.addEventListener('input', () => renderModalTree(searchInput.value));
        }

        function renderTree(nodes, container, isModal, checkedIds = []) {
            nodes.forEach(node => {
                const listItem = document.createElement('li');
                const hasChildren = node.children && node.children.length > 0;
                const itemContainer = document.createElement('div');
                itemContainer.className = 'item-container';
                if (hasChildren) {
                    const expandedIds = isModal ? [] : getExpandedState();
                    const isCollapsed = !expandedIds.includes(node.id);
                    if (!isModal) {
                        listItem.classList.toggle('collapsed', isCollapsed);
                    } else {
                        listItem.classList.add('collapsed');
                    }
                    const toggleBtn = document.createElement('span');
                    toggleBtn.className = 'toggle-btn';
                    toggleBtn.textContent = listItem.classList.contains('collapsed') ? '▸' : '▾';
                    toggleBtn.onclick = (e) => {
                        e.stopPropagation();
                        const nowIsCollapsed = listItem.classList.toggle('collapsed');
                        toggleBtn.textContent = nowIsCollapsed ? '▸' : '▾';
                        if (!isModal) {
                            let currentState = getExpandedState();
                            if (nowIsCollapsed) {
                                currentState = currentState.filter(id => id !== node.id);
                            } else {
                                if (!currentState.includes(node.id)) currentState.push(node.id);
                            }
                            saveExpandedState(currentState);
                        }
                    };
                    itemContainer.appendChild(toggleBtn);
                } else {
                    const emptySpan = document.createElement('span');
                    emptySpan.style.display = 'inline-block';
                    emptySpan.style.width = '20px';
                    itemContainer.appendChild(emptySpan);
                }
                if (isModal) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'modal-checkbox';
                    checkbox.dataset.id = node.id;
                    checkbox.dataset.title = node.data.title;
                    if (checkedIds.includes(node.id)) checkbox.checked = true;
                    if (node.id === currentSelectedDocId) checkbox.disabled = true;
                    itemContainer.appendChild(checkbox);
                }
                const titleSpan = document.createElement('span');
                titleSpan.className = 'tree-item-title';
                titleSpan.textContent = node.data.title;
                titleSpan.dataset.id = node.id;
                if (!isModal) {
                    titleSpan.draggable = true;
                    titleSpan.addEventListener('dragstart', (e) => {
                        e.stopPropagation();
                        e.dataTransfer.setData('text/plain', node.id);
                        e.dataTransfer.effectAllowed = 'move';
                        setTimeout(() => e.target.classList.add('dragging'), 0);
                    });
                    titleSpan.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
                    titleSpan.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        e.target.classList.add('drop-target');
                    });
                    titleSpan.addEventListener('dragleave', (e) => e.target.classList.remove('drop-target'));
                    titleSpan.addEventListener('drop', handleDrop);
                    titleSpan.onclick = () => {
                        const currentActive = document.querySelector('#tree-root .tree-item-title.active');
                        if (currentActive) currentActive.classList.remove('active');
                        titleSpan.classList.add('active');
                        loadDocumentIntoEditor(node.id, node.data);
                    };
                }
                itemContainer.appendChild(titleSpan);
                listItem.appendChild(itemContainer);
                if (hasChildren) {
                    const childrenContainer = document.createElement('ul');
                    listItem.appendChild(childrenContainer);
                    renderTree(node.children, childrenContainer, isModal, checkedIds);
                }
                container.appendChild(listItem);
            });
        }

        function filterTree(nodes, filterText) {
            const filteredNodes = [];
            for (const node of nodes) {
                let matches = node.data.title.toLowerCase().includes(filterText);
                let children = [];
                if (node.children && node.children.length > 0) {
                    children = filterTree(node.children, filterText);
                }
                if (matches || children.length > 0) {
                    filteredNodes.push({ ...node,
                        children: children
                    });
                }
            }
            return filteredNodes;
        }

        async function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.classList.remove('drop-target');
            const draggedDocId = e.dataTransfer.getData('text/plain');
            const newParentId = e.target.dataset.id;
            if (draggedDocId === newParentId) return;
            let tempId = newParentId;
            while (tempId) {
                if (tempId === draggedDocId) {
                    showModalAlert("자신의 하위 항목으로 문서를 이동할 수 없습니다.");
                    return;
                }
                const parentNode = allDocsMap.get(tempId);
                if (!parentNode) break;
                tempId = parentNode.data.parentIds && parentNode.data.parentIds.length > 0 ? parentNode.data.parentIds[0] : null;
            }
            try {
                await updateDoc(doc(db, "helps", draggedDocId), {
                    parentIds: [newParentId]
                });
                buildAndRenderTree();
            } catch (error) {
                console.error("부모 변경 중 오류:", error);
                showModalAlert("부모를 변경하는 데 실패했습니다.");
            }
        }

        let isResizing = false;
        if (resizer) {
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                e.preventDefault();
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
        }

        function handleMouseMove(e) {
            if (!isResizing || !treeContainer || !treeContainer.parentElement) return;
            const containerRect = treeContainer.parentElement.getBoundingClientRect();
            let newLeftWidth = e.clientX - containerRect.left;
            if (newLeftWidth < 200) newLeftWidth = 200;
            if (newLeftWidth > containerRect.width - 200) newLeftWidth = containerRect.width - 200;
            treeContainer.style.width = `${newLeftWidth}px`;
        }

        function handleMouseUp() {
            isResizing = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }

        function toggleMode() {
            if (!isCurrentUserAdmin) {
                showModalAlert('관리자 권한이 없습니다.');
                return;
            }
            const isViewerVisible = viewerContainer.style.display !== 'none';
            const toggleBtn = document.getElementById('mode-toggle-btn');

            if (isViewerVisible) {
                viewerContainer.style.display = 'none';
                adminContainer.style.display = 'flex';
                if (toggleBtn) toggleBtn.textContent = '뷰어 모드로';
                buildAndRenderTree();
            } else {
                viewerContainer.style.display = 'flex';
                adminContainer.style.display = 'none';
                if (toggleBtn) toggleBtn.textContent = '관리자 페이지';
                navigateTo(null, 'Home');
            }
        }

        async function loadGlobalLeftMargin() {
            if (!db) return;
            try {
                const docSnap = await getDoc(doc(db, "globals", "left_margin"));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    leftMarginContainer.textContent = data.content || '';
                } else {
                    leftMarginContainer.textContent = '안내문이 없습니다.';
                }
            } catch (error) {
                console.error("안내문 로딩 오류:", error);
                leftMarginContainer.textContent = '안내문을 불러오는 데 실패했습니다.';
            }
        }

        async function loadGlobalNoticeEditor() {
            const currentActive = document.querySelector('#tree-root .tree-item-title.active');
            if (currentActive) currentActive.classList.remove('active');
            currentSelectedDocId = null;

            editorContent.innerHTML = '<p class="info-text">안내문 내용을 불러오는 중...</p>';
            try {
                const docSnap = await getDoc(doc(db, "globals", "left_margin"));
                const currentContent = docSnap.exists() ? docSnap.data().content : '';

                editorContent.innerHTML = `
                    <h3>공지/안내문 수정</h3>
                    <div class="form-group">
                        <label><span>모든 페이지 좌측에 공통으로 표시될 내용</span></label>
                        <textarea id="global-notice-textarea" style="min-height: 200px; resize: vertical;"></textarea>
                    </div>
                    <div class="button-group">
                        <button id="save-global-notice-button">저장하기</button>
                    </div>
                `;
                document.getElementById('global-notice-textarea').value = currentContent;
                document.getElementById('save-global-notice-button').onclick = saveGlobalNotice;

            } catch (error) {
                console.error("안내문 편집기 로딩 오류:", error);
                editorContent.innerHTML = '<p class="info-text">편집기를 불러오는 데 실패했습니다.</p>';
            }
        }

        async function saveGlobalNotice() {
            const saveButton = document.getElementById('save-global-notice-button');
            const newContent = document.getElementById('global-notice-textarea').value;

            saveButton.textContent = '저장 중...';
            saveButton.disabled = true;

            try {
                await setDoc(doc(db, "globals", "left_margin"), {
                    content: newContent
                });
                showModalAlert("안내문이 저장되었습니다.");
                await loadGlobalLeftMargin();
            } catch (error) {
                console.error("안내문 저장 오류:", error);
                showModalAlert("저장에 실패했습니다.");
            } finally {
                saveButton.textContent = '저장하기';
                saveButton.disabled = false;
            }
        }

        function showModal(options) {
            const { content, confirmText, onConfirm, id, modalClass, cancelText, onCancel, confirmId } = options;
            
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            
            const modalContainer = document.createElement('div');
            modalContainer.className = 'modal-content';
            if (id) modalContainer.id = id;
            if (modalClass) modalContainer.classList.add(modalClass);
            
            // confirmText가 있을 때만 확인 버튼을 생성하도록 수정
            const confirmButtonHtml = confirmText ? `<button id="${confirmId || 'modal-confirm'}">${confirmText}</button>` : '';
            
            modalContainer.innerHTML = `
                ${content}
                <div class="modal-buttons">
                    <button id="modal-cancel">${cancelText || '취소'}</button>
                    ${confirmButtonHtml}
                </div>
            `;
            
            modalOverlay.appendChild(modalContainer);
            document.body.appendChild(modalOverlay);
            modalOverlay.style.display = 'flex';

            if (confirmText) {
                const confirmButton = modalOverlay.querySelector(`#${confirmId || 'modal-confirm'}`);
                confirmButton.onclick = onConfirm || closeModal;
            }
            
            const cancelButton = modalOverlay.querySelector('#modal-cancel');
            cancelButton.onclick = onCancel || closeModal;
            modalOverlay.onclick = (e) => {
                if (e.target === modalOverlay) {
                    onCancel ? onCancel() : closeModal();
                }
            };
        }

        function showModalAlert(message) {
            showModal({
                content: `<p style="margin-top:0;">${message}</p>`,
                confirmText: '확인',
                confirmId: 'modal-alert-ok',
                modalClass: 'modal-confirm',
                onConfirm: closeModal
            });
            // 취소 버튼을 숨기기 위해 cancel 버튼을 찾아서 숨김
            setTimeout(() => {
                const cancelButton = document.querySelector('.modal-overlay:last-of-type #modal-cancel');
                if (cancelButton) cancelButton.style.display = 'none';
                document.getElementById('modal-alert-ok')?.focus()
            }, 0);
        }

        function closeModal() {
            const modals = document.querySelectorAll('.modal-overlay');
            if (modals.length > 0) {
                document.body.removeChild(modals[modals.length - 1]);
            }
        }

        async function processUser(user) {
            if (user) {
                isCurrentUserAdmin = await checkAdminStatus(user.email);
                updateAuthUI(user, isCurrentUserAdmin);

                if (!isCurrentUserAdmin) {
                    viewerContainer.style.display = 'flex';
                    adminContainer.style.display = 'none';
                }
            } else {
                isCurrentUserAdmin = false;
                updateAuthUI(null, false);
                viewerContainer.style.display = 'flex';
                adminContainer.style.display = 'none';
            }
        }


        // -------------------------------------------------------------
        // 이벤트 리스너 설정 및 초기화
        // -------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM이 로드되었습니다. 이제 Firebase 로직을 시작합니다.");

            if (!db || !auth) {
                console.log("Firebase가 초기화되지 않아 앱을 시작할 수 없습니다.");
                return;
            }

            onAuthStateChanged(auth, user => {
                processUser(user);
            });

            adminContainer.addEventListener('click', (event) => {
                const targetId = event.target.id;

                switch (targetId) {
                    case 'add-new-button':
                        prepareNewDocumentForm();
                        break;
                    case 'edit-global-notice-button':
                        loadGlobalNoticeEditor();
                        break;
                    case 'manage-admins-button':
                        openAdminManagementUI();
                        break;
                }
            });

            if (searchButton) searchButton.addEventListener('click', performSearch);
            if (searchInput) searchInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') performSearch();
            });

            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('copy-path-btn')) {
                    const path = e.target.dataset.path;
                    const textarea = document.createElement('textarea');
                    textarea.value = path;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        const originalText = e.target.textContent;
                        e.target.textContent = '복사 완료!';
                        setTimeout(() => {
                            e.target.textContent = originalText;
                        }, 1500);
                    } catch (err) {
                        console.error('클립보드 복사 실패:', err);
                        showModalAlert('클립보드 복사에 실패했습니다.');
                    }
                    document.body.removeChild(textarea);
                }
            });


            if (appTitle) {
                appTitle.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (adminContainer.style.display !== 'none') {
                        const toggleBtn = document.getElementById('mode-toggle-btn');
                        viewerContainer.style.display = 'flex';
                        adminContainer.style.display = 'none';
                        if (toggleBtn) toggleBtn.textContent = '관리자 페이지';
                    }
                    navigateTo(null, 'Home');
                });
            }

            navigateTo(null, 'Home');
            loadGlobalLeftMargin();
        });
    </script>
</body>

</html>
